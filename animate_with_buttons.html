<!DOCTYPE html>

<head>

	<script src="https://unpkg.com/scrollama"></script>
	<script src="https://unpkg.com/d3@5.9.1/dist/d3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
			integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
			crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-2.26.0.min.js" charset="utf-8"></script>
	<link rel="stylesheet" href="css/style.css" />
	<style>
		#scrolly {
			position: relative;
			display: -webkit-box;
			display: -ms-flexbox;
			display: flex;
			background-color: #f3f3f3;
			padding: 1rem;
		}

			#scrolly > * {
				-webkit-box-flex: 1;
				-ms-flex: 1;
				flex: 1;
			}

		article {
			position: relative;
			padding: 0 1rem;
			max-width: 20rem;
		}

		figure {
			position: -webkit-sticky;
			position: sticky;
			width: 100%;
			margin: 0;
			-webkit-transform: translate3d(0, 0, 0);
			-moz-transform: translate3d(0, 0, 0);
			transform: translate3d(0, 0, 0);
			background-color: #8a8a8a;
			z-index: 0;
		}

			figure p {
				text-align: center;
				padding: 1rem;
				position: absolute;
				top: 50%;
				left: 50%;
				-moz-transform: translate(-50%, -50%);
				-webkit-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
				font-size: 8rem;
				font-weight: 900;
				color: #fff;
			}

		.step {
			margin: 0 auto 2rem auto;
			background-color: #3b3b3b;
			color: #fff;
		}

			.step:last-child {
				margin-bottom: 0;
			}

			.step.is-active {
				background-color: goldenrod;
				color: #3b3b3b;
			}

			.step p {
				text-align: center;
				padding: 1rem;
				font-size: 1.5rem;
			}
	</style>
	<link rel="stylesheet" href="css/scroll.css" />
	<link rel="stylesheet" href="css/responsive.css" />
</head>
<body>
	<main>
		<nav>
			<a href="https://github.com/russellsamora/scrollama">scrollama.js</a>
			<div class="nav__examples">
				<p>Examples:</p>
				<a href="https://russellsamora.github.io/scrollama/basic">Basic</a>
				<a href="https://russellsamora.github.io/scrollama/progress">Progress</a>
				<a href="https://russellsamora.github.io/scrollama/sticky-side">Sticky Side</a>
				<a href="https://russellsamora.github.io/scrollama/sticky-overlay">Sticky Overlay</a>
				<a href="https://russellsamora.github.io/scrollama/mobile-pattern">Mobile Pattern</a>
			</div>
		</nav>
		<section id="intro">
			<h1 class="intro__hed">Sticky Side Example</h1>
			<p class="intro__dek">
				Start scrolling to see how it works.
			</p>
		</section>

		<section id="scrolly">
			<article>
				<div class="step is-active" data-step="1" style="height: 814px;" data-scrollama-index="0">
					<p>STEP 1: This is the plot of Sutpen's life in AA'</p>
				</div>
				<div class="step" data-step="2" style="height: 814px;" data-scrollama-index="1">
					<p>STEP 2: This is what this would look like in the order of events as they actually occur in his life.</p>
				</div>

				<div class="step" data-step="3" style="height: 814px;" data-scrollama-index="2">
					<p>STEP 3</p>
				</div>
				<div class="step" data-step="3" style="height: 814px;" data-scrollama-index="3">
					<p>STEP 4</p>
				</div>
				<div class="step" data-step="4" style="height: 814px;" data-scrollama-index="4">
					<p>STEP 5: story</p>
				</div>
				<div class="step" data-step="5" style="height: 814px;" data-scrollama-index="5">
					<p>STEP 5: story</p>
				</div>
			</article>

			<figure style="height: 543px; top: 271.5px;">
				<div id="plotchart"></div>
			</figure>
		</section>

		<section id="outro"></section>
	</main>
	
	
	
	



	
	<script>

		// using d3 for convenience
		var main = d3.select("main");
		var scrolly = main.select("#scrolly");
		var figure = scrolly.select("figure");
		var article = scrolly.select("article");
		var step = article.selectAll(".step");

		// initialize the scrollama
		var scroller = scrollama();

		// generic window resize listener event
		function handleResize() {
			// 1. update height of step elements
			var stepH = Math.floor(window.innerHeight * 0.75);
			step.style("height", stepH + "px");

			var figureHeight = window.innerHeight / 2;
			var figureMarginTop = (window.innerHeight - figureHeight) / 2;

			figure
				.style("height", figureHeight + "px")
				.style("top", figureMarginTop + "px");

			// 3. tell scrollama to update new element dimensions
			scroller.resize();
		}

		// scrollama event handlers
		function handleStepEnter(response) {
			
		
			step.classed("is-active", function (d, i) {
				return i === response.index;
			});

			
			// update graphic based on step
			startAnimation(response.index);
		}

		function init() {

			// 1. force a resize on load to ensure proper dimensions are sent to scrollama
			handleResize();

			// 2. setup the scroller passing options
			// 		this will also initialize trigger observations
			// 3. bind scrollama event handlers (this can be chained like below)
			scroller
				.setup({
					step: "#scrolly article .step",
					offset: 0.33,
					debug: false
				})
				.onStepEnter(handleStepEnter);
		}

		// kick things off
		init();


		makePlot();

/*
		Plotly.plot('plotchart', [{
			x: [0, 0],
			y: [-1, 1],
		}], {
			xaxis: { range: [-Math.PI, Math.PI] },
			yaxis: { range: [-1.3, 1.3] }
		}, { showSendToCloud: true }).then(function () {
			Plotly.addFrames('graph', [
				{
					data: [{ x: [1, -.5], y: [0, .5] }],
					name: 'frame1'
				}, {
					data: [{ x: [0, 0], y: [-.25, .35] }],
					name: 'frame2'
				},
				{
					data: [{ x: [0, 1,2,4], y: [-1,4,-2, 1] }],
					name: 'frame3'
				}
			]);
		})*/
		

		function startAnimation(i) {
		
			var currentFrame = 'frame' + i
			console.log(currentFrame)

			if (i < 3) {
				Plotly.animate('plotchart', [currentFrame], {
					frame: [
						{ duration: 500 }
					],
					transition: [
						{ duration: 500, easing: 'circle' }
					],
					mode: 'afterall',
					ordering: 'traces first',
					redraw: true
				})
			} else {
				Plotly.animate('plotchart', [currentFrame], {
					frame: [
						{ duration: 0 }
					],
					transition: [
						{ duration: 0, easing: 'circle' }
					],
					mode: 'afterall',
					ordering: 'traces first',
					redraw: true
				})
			}
		}

		function makePlotly(data) {
		console.log(data)


			const scatterPlotColors = [
				'rgba(255, 99, 132, 1.0)',
				'rgba(54, 162, 235, 1.0)',
				'rgba(255, 206, 86, 1.0)',
				'rgba(75, 192, 192, 1.0)',
				'rgba(153, 102, 255, 1.0)',
				'rgba(255, 159, 64, 1.0)'
			]


		//Sutpen Variables from frame0 and frame1. These have to be read in as pure arrays rather than arrays in an object. Not sure why, but plotly does not like the object format.
			const x_sutpen_plot = data['x_sutpen_plot'];
			const y_sutpen = data['y_sutpen'];
			const x_sutpen_story = data['x_sutpen_story'];
			const textposition_sutpen_plot = data['textposition_sutpen_plot'];
			const sutpen_label = data['sutpen_label'];
			const textposition_sutpen_story = data['textposition_sutpen_story'];


		//Overall chart variables
			const absalom_y_all = data['absalom_y_all'];
			const absalom_x_plot = data['absalom_x_plot'];
			const absalom_x_story = data['absalom_x_story'];
			const absalom_label = data['absalom_label'];
			const absalom_textposition_plot = data['absalom_textposition_plot'];
			const absalom_textposition_story = data['absalom_textposition_story'];
			const absalom_y_narrated = data['absalom_y_narrated'];
			const absalom_y_told = data['absalom_y_told'];
			const absalom_y_other = data['absalom_y_other'];
			const absalom_major_event = data['absalom_major_event'];


			var data = [{
				type: "scatter",
				mode: "markers+text",
				x: x_sutpen_plot,
				y: y_sutpen,
				marker:
				{
					color: scatterPlotColors[1],
					opacity:.5
				},
				text: sutpen_label,
				textposition: textposition_sutpen_plot
				

			}];

			var layout_sutpen_plot = {
				title: { text: "<b>Narrative Structure Chart</b> <br>Major Events in Sutpen's Life in Plot Order" },
				showlegend: false,
				xaxis: {
					showgrid: false,
					title: { text: "Chapter" },
					autotick: false,
					tickmode: 'array',
					tickvals: [1, 2, 3, 4, 5, 6, 7, 8, 9],
					range: [0.5, 9]
				},
				yaxis: {
					title: { text: "Chronology" },
					showgrid: false,
					tickmode: 'array',
					tickvals: [1, 2, 3],
					range:[.5,3.5],
					zeroline: false
				},

				
			};

			var layout_sutpen_story = {
				title: { text: "<b>Narrative Structure Chart</b> <br>Major Events in Sutpen's Life in Story Order" },
				showlegend: false,
				xaxis: {
					showgrid: false,
					title: { text: "Chapter" },
					autotick: false,
					tickmode: 'array',
					tickvals: [1, 2, 3, 4, 5, 6, 7, 8, 9],
					range: [0.5, 9]
				},
				yaxis: {
					title: { text: "Chronology" },
					showgrid: false,
					tickmode: 'array',
					tickvals: [1, 2, 3],
					range: [.5, 3.5],
					zeroline: false
				},


			};

			var layout_absalom_plot = {
				title: { text: "<b>Narrative Structure Chart</b> <br><i>Absalom, Abasalom!</i> in Plot Order" },
				showlegend: false,
				xaxis: {
					showgrid: false,
					title: { text: "Chapter" },
					autotick: false,
					tickmode: 'array',
					tickvals: [1, 40, 93, 150, 236, 287, 375, 496, 621],
					ticktext: [1, 2, 3, 4, 5, 6, 7, 8, 9],
					range:[0,650]
				},
				yaxis: {
					title: { text: "Chronology" },
					showgrid: false,
					autotick:true,
					tickmode: 'array',
					tickvals: [100,200,300,400,500,600,700],
					range:[0,699],
					zeroline: false
				}
			}

			var layout_absalom_narrated = {
				title: { text: "<b>Narrative Structure Chart</b> <br><i>Absalom, Abasalom!</i> Narrated Events" },
				showlegend: true,
				legend: {
					title:
						{ text: "Legend" }
						},
				xaxis: {
					showgrid: false,
					title: { text: "Chapter" },
					autotick: false,
					tickmode: 'array',
					tickvals: [1, 40, 93, 150, 236, 287, 375, 496, 621],
					ticktext: [1, 2, 3, 4, 5, 6, 7, 8, 9],
					range:[0,650]
				},
				yaxis: {
					title: { text: "Chronology" },
					showgrid: false,
					autotick:true,
					tickmode: 'array',
					tickvals: [100,200,300,400,500,600,700],
					range:[0,699],
					zeroline: false
				},
				
			}

			var layout_absalom_narrated_told = {
				title: { text: "<b>Narrative Structure Chart</b> <br><i>Absalom, Abasalom!</i> Narrated and Told Events" },
				showlegend: true,
				legend: {
					title:
						{ text: "Legend" }
				},
				xaxis: {
					showgrid: false,
					title: { text: "Chapter" },
					autotick: false,
					tickmode: 'array',
					tickvals: [1, 40, 93, 150, 236, 287, 375, 496, 621],
					ticktext: [1, 2, 3, 4, 5, 6, 7, 8, 9],
					range: [0, 650]
				},
				yaxis: {
					title: { text: "Chronology" },
					showgrid: false,
					autotick: true,
					tickmode: 'array',
					tickvals: [100, 200, 300, 400, 500, 600, 700],
					range: [0, 699],
					zeroline: false
				},

			}

				var layout_absalom_story = {
					title: { text: "<b>Plot Structure Chart</b> <br>Major Events in Sutpen's Life" },
					showlegend: false,
					xaxis: {
						showgrid: false,
						title: { text: "Chapter" },
						tickvals: [1, 40, 93, 150, 236, 287, 375, 496, 621],
						ticktext: [1, 2, 3, 4, 5, 6, 7, 8, 9],
						
						tickmode: 'array',
						
						range: [0.5, 644]
					},
					yaxis: {
						title: { text: "Chronology" },
						showgrid: false,
						autotick: true,
						tickmode: 'array',
						tickvals: [100, 200, 300, 400, 500, 600, 700],
						range: [0, 699],
						zeroline: false
					}

			};

			var config = {
				responsive: true,
				displayModeBar: false
			}


			Plotly.newPlot('plotchart', {
				data: data,
				layout: layout_sutpen_plot,
				config: config
			})

			Plotly.addTraces('plotchart',
				{
				x: [0, 0],
				y: [0, 0]
				}
			);
			Plotly.addTraces('plotchart',
				{
					x: [0, 0],
					y: [0, 0]
				}
			);


				Plotly.addFrames('plotchart', [
					{
						name: 'frame0',
						data: [{
							x: x_sutpen_plot,
							y: y_sutpen,
							text: sutpen_label,
							textposition: textposition_sutpen_plot,
							marker: {
								color: scatterPlotColors[1],
								opacity:.5
							}
						}],
						layout: layout_sutpen_plot
					},
					{
						name: 'frame1',
						data: [{
							x: x_sutpen_story,
							y: y_sutpen,
							text: sutpen_label,
							textposition: textposition_sutpen_story,
							marker:
							{
								color: scatterPlotColors[1],
								opacity: .5
							}
						},
							{
								visible:false,
							},
							{ visible: false }
						],
						layout: layout_sutpen_story
					},
					{
						name: 'frame2',
						data: [{
							type: "scatter",
							mode: "markers",
							name:"all",
							x: absalom_x_plot,
							y: absalom_y_all,
							text: absalom_label,
							textposition: absalom_textposition_plot,
							marker:
							{
								color: scatterPlotColors[1],
								opacity: .5
							},
							text: null,
							textposition: null,
						},
							{
								visible:true,
								type: "scatter",
								mode: "markers+text",
								name: "Major Events",
								x: absalom_x_plot,
								y: absalom_major_event,
								text: absalom_label,
								textposition: absalom_textposition_plot,
								marker:
								{
									size:20,
									color: scatterPlotColors[0],
									opacity: .7
								},
							},
							{ visible: false }
						],
						layout: layout_absalom_plot
					},
					{
						name: 'frame3',
						data: [{
							x: absalom_x_plot,
							y: absalom_y_narrated,
							name: "Narrated",
							mode: "markers+text",
							marker: {
								color: scatterPlotColors[2],
								opacity:.5
							},
							text: null,
							textposition: null,
						},
							{
								visible: false,
							},
							{ visible: false }],
						layout: layout_absalom_narrated
					},
					{
						name: 'frame4',
						data: [
							
							{
								type: "scatter",
								mode: "markers",
								x: absalom_x_plot,
								y: absalom_y_narrated,

								marker: {
									color: scatterPlotColors[2],
									opacity: .2
								},
								name: "Narrated",
								text: null,
								textposition: null,
							},
							{
								type: "scatter",
								mode: "markers",
								x: absalom_x_plot,
								y: absalom_y_told,
								marker: {
									color: scatterPlotColors[3],
									opacity: .5
								},
								name: "Told",
								text: null,
								textposition: null,
								visible: true
							},
							{
								visible:false
							}

						],
						layout: layout_absalom_narrated_told
					},
					{
						name: 'frame5',
						data: [{
							type: "scatter",
							mode: "markers",
							x: absalom_x_plot,
							y: absalom_y_narrated,
							marker: {
								color: scatterPlotColors[2],
								opacity:.2
							},
							name: "Narrated"
							/*text: absalom_label,
							textposition: absalom_textposition_plot*/
						},
						{
							type: "scatter",
							mode: "markers",
							x: absalom_x_plot,
							y: absalom_y_told,
							marker: {
								color: scatterPlotColors[3],
								opacity:.2
							},
							name: "Told",
							visible:true
							},
							{
								type: "scatter",
								mode: "markers+text",
								x: absalom_x_plot,
								y: absalom_y_other,
								marker: {
									color: scatterPlotColors[4],
									opacity:.5
								},
								name: "Other",
								visible:true
							}

						],
						layout: layout_absalom_narrated
					},
					{
						name: 'frame6',
						data: [{
							mode: "markers+text",
							text: absalom_label,
							textposition: absalom_textposition_story,
							x: absalom_x_story,
							y: absalom_y_all,
							
						}],
						layout: layout_absalom_story
					}
				]);
			
/*
			plotly.addTrace('plotchart', {
				x: [0, 0],
				y: [0,0]
			});*/

		};


		function makePlot() {
			;
			$.ajax({
				type: "GET",
				url: "https://raw.githubusercontent.com/arundhatibala/absalom/main/data/sutpen_absalom_plot_major_events.csv",
				dataType: "text",
				success: function (response) {
				    console.log(response)
													
					var allData = {};
					allData = processData(response)
					console.log("All data", allData)
					makePlotly(allData);
					

				}
			});
		};


		function processData(response) {
		    
			data = $.csv.toObjects(response, { headers: true });

			plotData = {};

			/* console.log(allRows);
			 console.log(allRows.length)*/
			plotData.absalom_eventid = data.map(function (d) {
				return parseInt(d['absalom_eventid']) || null;
			});

			plotData.absalom_startdate = data.map(function (d) { return d['absalom_startdate']; });
		
			plotData.absalom_summary = data.map(function (d) { return d['absalom_summary']; });
			plotData.absalom_chapter = data.map(function (d) {
					return parseInt(d['absalom_chapter']) || null;});
			plotData.absalom_y_narrated = data.map(function (d) {
					return parseInt(d['absalom_y_narrated'])|| null;
			});
			plotData.absalom_y_hypothesized = data.map(function (d) { return parseInt(d['absalom_y_hypothesized'])|| null; });
			plotData.absalom_y_narratedconsciousness = data.map(function (d) { return parseInt(d['absalom_y_narratedconsciousness']) || null; });
			plotData.absalom_y_told = data.map(function (d) { return parseInt(d['absalom_y_told'])|| null; });
			plotData.absalom_y_remembered = data.map(function (d) { return parseInt(d['absalom_y_remembered'])|| null; });
			plotData.absalom_y_all = data.map(function (d) { return parseInt(d['absalom_y_all']) || null; });
			plotData.absalom_y_other = data.map(function (d) { return parseInt(d['absalom_y_other']) || null; });
			plotData.absalom_x_plot = data.map(function (d) { return parseInt(d['absalom_x_plot']) || null; });
			plotData.absalom_x_story = data.map(function (d) { return parseInt(d['absalom_x_story']) || null; });
			plotData.absalom_textposition_plot = data.map(function (d) { return d['absalom_textposition_plot']; });
			plotData.absalom_textposition_story = data.map(function (d) { return d['absalom_textposition_story']; });
			plotData.absalom_label = data.map(function (d) { return d['absalom_label']; });
			plotData.absalom_major_event = data.map(function (d) { return parseInt(d['absalom_major_event']) || null});
			plotData.x_sutpen_plot = data.map(function (d) { return parseInt(d['x_sutpen_plot']) || null; });
			plotData.x_sutpen_story = data.map(function (d) { return parseInt(d['x_sutpen_story'])||null; });
			plotData.y_sutpen = data.map(function (d) { return parseInt(d['y_sutpen'])||null; });
			plotData.series_sutpen_plot = data.map(function (d) { return d['series_sutpen_plot']; });
			plotData.series_sutpen_story = data.map(function (d) { return d['series_sutpen_story']; });
			plotData.sutpen_label = data.map(function (d) { return d['sutpen_label']; });
			plotData.textposition_sutpen_plot = data.map(function (d) { return d['textposition_sutpen_plot']; });
			plotData.textposition_sutpen_story = data.map(function (d) { return d['textposition_sutpen_story']; });



			console.log(plotData)
						
			return plotData
		}
		
		
	</script>
</body>